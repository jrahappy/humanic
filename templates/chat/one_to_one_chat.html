<div class="container mx-auto p-4">
    <h1 class="text-2xl mb-4">Chat with {{ receiver.username }}</h1>
    <div id="chat-messages" class="chat-container">
        {% for message in messages %}
            <div class="message {% if message.sender == user %}you{% else %}other{% endif %}">
                <strong>{{ message.sender.username }}</strong>: {{ message.content }}
                <small>{{ message.timestamp }}</small>
            </div>
        {% endfor %}
    </div>
    <form id="chat-form" hx-post="{% url 'chat:send_message' %}" hx-target="#chat-messages" hx-swap="beforeend">
        {% csrf_token %}
        <input type="text" name="message" class="border p-2 w-full" required>
        <input type="hidden" name="receiver_id" value="{{ receiver_id }}">
        <button type="submit" class="bg-blue-500 text-white p-2 mt-2">Send</button>
    </form>
</div>

<script>
    // Initialize WebSocket with proper protocol detection
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/chat/{{ receiver_id }}/`);

    // Handle successful connection
    ws.onopen = function() {
        console.log(`WebSocket connected successfully to ${wsProtocol}//${window.location.host}/ws/chat/{{ receiver_id }}/`);
        const messages = document.getElementById('chat-messages');
        messages.innerHTML += `
            <div class="message system">
                <small>Connected to chat</small>
            </div>`;
        messages.scrollTop = messages.scrollHeight;
    };

    // Handle incoming messages
    ws.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            const messages = document.getElementById('chat-messages');
            if (!data.sender || !data.message || !data.timestamp) {
                console.error('Invalid message format:', data);
                return;
            }
            const timestamp = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            data.timestamp = timestamp; // Format timestamp for display
            const chat_form = document.getElementById('chat-form');
            messages.innerHTML += `
                <div class="message ${data.sender === '{{ user.username }}' ? 'you' : 'other'}">
                    <strong>${data.sender}</strong>: ${data.message}
                    <small>${data.timestamp}</small>
                </div>`;
            messages.scrollTop = messages.scrollHeight;
            chat_form.reset(); // Clear the input field after sending
            
        } catch (e) {
            console.error('Error parsing WebSocket message:', e);
        }
    };

    // Handle connection closure
    ws.onclose = function(event) {
        console.error('WebSocket closed. Code:', event.code, 'Reason:', event.reason);
        const messages = document.getElementById('chat-messages');
        messages.innerHTML += `
            <div class="message system error">
                <small>Chat disconnected. Please refresh the page.</small>
            </div>`;
        messages.scrollTop = messages.scrollHeight;
    };

    // Handle connection errors
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        const messages = document.getElementById('chat-messages');
        messages.innerHTML += `
            <div class="message system error">
                <small>Failed to connect to chat. Please try again.</small>
            </div>`;
        messages.scrollTop = messages.scrollHeight;
    };
</script>